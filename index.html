<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adopt(k) - 401(k) Adoption Agreement Parser</title>
  
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0F172A;
      color: #E2E8F0;
      line-height: 1.5;
    }
    .hidden { display: none !important; }

    /* Layout */
    #docuwaivz-app { display: flex; height: 100vh; overflow: hidden; }
    .sidebar {
      width: 320px;
      background: #0F172A;
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      color: white;
      flex-shrink: 0;
    }
    .sidebar-header { padding: 2rem 1.25rem 1rem; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
    .sidebar-footer { padding: 1rem; border-top: 1px solid #334155; background: rgba(30, 41, 59, 0.5); }
    .main-content { flex: 1; overflow-y: auto; background: #0F172A; padding: 2rem; }

    /* Logo */
    .logo { font-size: 2.25rem; font-weight: 700; color: white; letter-spacing: -0.025em; }
    .logo-accent { color: #0b5fff; margin-left: 2px; }

    /* Section title */
    .section-title {
      font-size: 0.75rem; font-weight: 600; color: #0b5fff;
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;
    }

    /* Form elements */
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: white; margin-bottom: 0.5rem; }
    .form-select {
      display: block; width: 100%; padding: 0.5rem 0.75rem;
      background: #1E293B; border: 1px solid #334155; border-radius: 0.375rem;
      color: white; font-size: 0.875rem; outline: none;
    }
    .form-select:focus { border-color: #0b5fff; box-shadow: 0 0 0 2px rgba(11, 95, 255, 0.25); }
    .form-hint { font-size: 0.75rem; color: #94A3B8; margin-top: 0.25rem; }

    /* Loader */
    .loader-dark {
      width: 18px; height: 18px;
      border: 2px solid #334155; border-top-color: #0b5fff;
      border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Upload area */
    .upload-area {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 100%; height: 8rem; background: #1E293B;
      border: 2px dashed #334155; border-radius: 0.5rem;
      cursor: pointer; transition: all 0.2s ease; opacity: 0.5; pointer-events: none;
    }
    .upload-area.enabled { opacity: 1; pointer-events: auto; border-color: #0b5fff; }
    .upload-area.enabled:hover { background: rgba(11, 95, 255, 0.1); }
    .upload-area input { display: none; }
    .upload-icon { width: 2rem; height: 2rem; margin-bottom: 0.75rem; color: #64748B; }
    .upload-area.enabled .upload-icon { color: #0b5fff; }

    /* Status */
    .status-section { background: #1E293B; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; }
    .status-row { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; }
    .error-box {
      margin-top: 0.75rem; padding: 0.75rem;
      background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 0.5rem; font-size: 0.75rem; color: #FCA5A5;
      max-height: 15rem; overflow-y: auto;
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
      border-radius: 0.375rem; cursor: pointer; transition: all 0.15s ease; border: none;
    }
    .btn-primary { background: #0b5fff; color: white; }
    .btn-primary:hover { background: #0047cc; }
    .btn-outline { background: transparent; color: #0b5fff; border: 1px solid #0b5fff; }
    .btn-outline:hover { background: #0b5fff; color: white; }
    .btn-secondary { background: transparent; color: #94A3B8; border: 1px solid #334155; }
    .btn-secondary:hover { background: #334155; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .w-full { width: 100%; }
    .mt-3 { margin-top: 0.75rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .pt-4 { padding-top: 1rem; }
    .border-t { border-top: 1px solid #334155; }

    /* Info buttons - Blue background with white text */
    .info-btn {
      display: flex; align-items: center; gap: 0.5rem; width: 100%;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      border: none; border-radius: 0.5rem; color: white;
      font-size: 0.875rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s ease; text-align: left;
    }
    .info-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(11, 95, 255, 0.4); }
    .info-btn svg { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
    .info-btn-content { flex: 1; }
    .info-btn-title { font-weight: 600; }
    .info-btn-subtitle { font-size: 0.7rem; opacity: 0.85; font-weight: 400; }
    .info-btn-badge {
      background: rgba(255, 255, 255, 0.2); padding: 0.125rem 0.5rem;
      border-radius: 9999px; font-size: 0.625rem; font-weight: 600;
    }

    /* Toggle */
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; }
    .toggle-label { font-size: 0.875rem; font-weight: 500; color: white; }
    .toggle-hint { font-size: 0.75rem; color: #94A3B8; }
    .toggle-switch {
      position: relative; width: 40px; height: 22px;
      background: #334155; border-radius: 9999px; cursor: pointer; transition: background 0.2s;
    }
    .toggle-switch.active { background: #0b5fff; }
    .toggle-switch::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 18px; height: 18px; background: white;
      border-radius: 50%; transition: transform 0.2s;
    }
    .toggle-switch.active::after { transform: translateX(18px); }

    /* Results */
    .results-header {
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      padding: 1.5rem; border-radius: 0.75rem 0.75rem 0 0; border: 1px solid #1e4ec1;
    }
    .results-title { font-size: 1.5rem; font-weight: 700; color: white; }
    .results-subtitle { font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin-top: 0.25rem; }

    .coverage-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
    .coverage-pill {
      display: inline-flex; align-items: center; gap: 0.375rem;
      padding: 0.375rem 0.75rem; border-radius: 9999px;
      font-size: 0.75rem; font-weight: 500;
    }
    .coverage-pill.certified { background: rgba(16, 185, 129, 0.15); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .coverage-pill.review { background: rgba(245, 158, 11, 0.15); color: #FBBF24; border: 1px solid rgba(245, 158, 11, 0.3); }
    .coverage-pill.silent { background: rgba(100, 116, 139, 0.15); color: #94A3B8; border: 1px solid rgba(100, 116, 139, 0.3); }

    .results-container {
      position: relative; background: #1E293B;
      border: 1px solid #334155; border-top: none; border-radius: 0 0 0.75rem 0.75rem;
    }

    /* Table */
    .results-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .results-table thead th {
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      color: white; padding: 0.75rem 1rem; text-align: left;
      font-weight: 600; position: sticky; top: 0; z-index: 10;
    }
    .results-table .field-col { width: 35%; }
    .results-table .value-col { width: 65%; }
    .results-table .section-header-row td {
      background: linear-gradient(90deg, #1E293B 0%, #0F172A 100%);
      color: #0b5fff; font-weight: 700; font-size: 0.75rem;
      text-transform: uppercase; letter-spacing: 0.05em;
      padding: 0.75rem 1rem; border-left: 3px solid #0b5fff;
    }
    .results-table .data-row td { padding: 0.625rem 1rem; border-bottom: 1px solid #334155; color: #E2E8F0; }
    .results-table .data-row:hover td { background: rgba(11, 95, 255, 0.05); }
    .results-table .field-cell { font-weight: 500; color: #94A3B8; background: rgba(30, 41, 59, 0.5); }
    .results-table .value-cell { background: transparent; }
    .results-table .value-cell.empty-value { color: #475569; font-style: italic; }

    /* Status badges */
    .status-badge {
      display: inline-flex; align-items: center; gap: 0.25rem;
      padding: 0.125rem 0.5rem; border-radius: 9999px;
      font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em;
    }
    .status-badge.certified { background: rgba(16, 185, 129, 0.15); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.3); }
    .status-badge.ambiguous { background: rgba(245, 158, 11, 0.15); color: #FBBF24; border: 1px solid rgba(245, 158, 11, 0.3); }
    .status-badge.conflict { background: rgba(239, 68, 68, 0.15); color: #F87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-badge.silent { background: rgba(100, 116, 139, 0.15); color: #94A3B8; border: 1px solid rgba(100, 116, 139, 0.3); }
    .status-badge.uncertain { background: rgba(139, 92, 246, 0.15); color: #A78BFA; border: 1px solid rgba(139, 92, 246, 0.3); }

    .source-btn {
      padding: 0.25rem 0.5rem; font-size: 0.625rem; font-weight: 500;
      border-radius: 0.25rem; border: 1px solid #0b5fff;
      color: #0b5fff; background: transparent; cursor: pointer; transition: all 0.15s ease;
    }
    .source-btn:hover { background: #0b5fff; color: white; }

    /* Overlay */
    .results-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.95);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 20; border-radius: 0 0 0.75rem 0.75rem;
    }
    .clock-spinner {
      width: 80px; height: 80px; border-radius: 50%;
      background: linear-gradient(135deg, #1E293B, #0F172A);
      border: 3px solid #0b5fff; position: relative;
      box-shadow: 0 0 20px rgba(11, 95, 255, 0.3);
    }
    .clock-hand-hour {
      position: absolute; width: 3px; height: 20px; background: #0b5fff;
      left: 50%; bottom: 50%; transform-origin: bottom center;
      transform: translateX(-50%); border-radius: 2px; animation: spin-reverse 3s linear infinite;
    }
    .clock-hand-minute {
      position: absolute; width: 2px; height: 28px; background: #60A5FA;
      left: 50%; bottom: 50%; transform-origin: bottom center;
      transform: translateX(-50%); border-radius: 2px; animation: spin-reverse 1s linear infinite;
    }
    @keyframes spin-reverse {
      from { transform: translateX(-50%) rotate(360deg); }
      to { transform: translateX(-50%) rotate(0deg); }
    }
    .overlay-text { margin-top: 1.5rem; font-size: 1rem; font-weight: 500; color: white; }
    .overlay-subtext { margin-top: 0.5rem; font-size: 0.75rem; color: #94A3B8; }

    /* Export */
    .export-panel { margin-top: 1rem; background: #1E293B; border-radius: 0.75rem; border: 1px solid #334155; overflow: hidden; }
    .export-header {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      display: flex; align-items: center; justify-content: space-between;
    }
    .export-title { font-size: 0.875rem; font-weight: 600; color: white; }
    .export-hint { font-size: 0.75rem; color: rgba(255, 255, 255, 0.9); }
    .export-buttons { padding: 1rem 1.5rem; display: flex; flex-wrap: wrap; gap: 0.75rem; }

    /* Modal */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
      z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem;
    }
    .modal-container {
      background: #1E293B; border: 1px solid #334155; border-radius: 1rem;
      max-width: 800px; width: 100%; max-height: 90vh; overflow: hidden;
      display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .modal-container.large { max-width: 900px; }
    .modal-header {
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h3 {
      margin: 0; font-size: 1.25rem; font-weight: 700; color: white;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .modal-close {
      background: rgba(255,255,255,0.1); border: none; color: white;
      width: 32px; height: 32px; border-radius: 50%; font-size: 1.25rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s;
    }
    .modal-close:hover { background: rgba(255,255,255,0.2); }
    .modal-body { padding: 0; overflow-y: auto; color: #E2E8F0; font-size: 0.875rem; line-height: 1.6; }
    .modal-footer {
      padding: 1rem 1.5rem; border-top: 1px solid #334155;
      display: flex; justify-content: flex-end; gap: 0.75rem; background: rgba(15, 23, 42, 0.5);
    }

    /* Tabs */
    .tabs-container { display: flex; flex-direction: column; height: 100%; }
    .tabs-header { display: flex; background: #0F172A; border-bottom: 1px solid #334155; padding: 0 1rem; }
    .tab-btn {
      padding: 1rem 1.5rem; background: transparent; border: none;
      color: #94A3B8; font-size: 0.875rem; font-weight: 500;
      cursor: pointer; position: relative; transition: color 0.2s;
    }
    .tab-btn:hover { color: white; }
    .tab-btn.active { color: #0b5fff; }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 3px; background: #0b5fff; border-radius: 3px 3px 0 0;
    }
    .tab-btn svg { width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle; }
    .tabs-content { flex: 1; overflow-y: auto; }
    .tab-panel { display: none; padding: 1.5rem; }
    .tab-panel.active { display: block; }

    /* Visual elements */
    .step-card {
      display: flex; gap: 1rem; padding: 1rem;
      background: rgba(11, 95, 255, 0.05); border: 1px solid rgba(11, 95, 255, 0.2);
      border-radius: 0.75rem; margin-bottom: 1rem; transition: all 0.2s ease;
    }
    .step-card:hover { background: rgba(11, 95, 255, 0.1); transform: translateX(4px); }
    .step-number {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 1.125rem; font-weight: 700; color: white; flex-shrink: 0;
    }
    .step-content h4 { font-size: 1rem; font-weight: 600; color: white; margin: 0 0 0.25rem 0; }
    .step-content p { font-size: 0.875rem; color: #94A3B8; margin: 0; }

    .feature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 1rem 0; }
    .feature-box { padding: 1rem; background: #0F172A; border: 1px solid #334155; border-radius: 0.75rem; text-align: center; }
    .feature-icon {
      width: 48px; height: 48px; margin: 0 auto 0.75rem;
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    .feature-box h4 { font-size: 0.875rem; font-weight: 600; color: white; margin: 0 0 0.25rem 0; }
    .feature-box p { font-size: 0.75rem; color: #94A3B8; margin: 0; }

    .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin: 1rem 0; }
    .status-explain-card { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: #0F172A; border-radius: 0.5rem; }
    .status-explain-card .status-badge { flex-shrink: 0; padding: 0.25rem 0.75rem; font-size: 0.7rem; }
    .status-explain-card .status-text { font-size: 0.8rem; color: #CBD5E1; }

    .flow-diagram {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 1.5rem; margin: 1rem 0;
      background: linear-gradient(135deg, rgba(11, 95, 255, 0.1) 0%, rgba(0, 71, 204, 0.1) 100%);
      border-radius: 0.75rem; overflow-x: auto;
    }
    .flow-step { display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 100px; }
    .flow-icon {
      width: 56px; height: 56px;
      background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%);
      border-radius: 16px; display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; margin-bottom: 0.5rem; box-shadow: 0 4px 12px rgba(11, 95, 255, 0.3);
    }
    .flow-label { font-size: 0.75rem; font-weight: 500; color: white; }
    .flow-arrow { font-size: 1.5rem; color: #0b5fff; }

    .highlight-box {
      background: rgba(11, 95, 255, 0.1); border: 1px solid rgba(11, 95, 255, 0.3);
      border-radius: 0.75rem; padding: 1rem; margin: 1rem 0;
    }
    .highlight-box.success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
    .highlight-box.warning { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); }
    .highlight-box-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: white; margin-bottom: 0.5rem; }
    .highlight-box-title svg { width: 1.25rem; height: 1.25rem; }

    .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
    .comparison-box { padding: 1rem; border-radius: 0.75rem; border: 2px solid; }
    .comparison-box.bad { background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.3); }
    .comparison-box.good { background: rgba(16, 185, 129, 0.05); border-color: rgba(16, 185, 129, 0.3); }
    .comparison-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.75rem; }
    .comparison-box.bad .comparison-header { color: #F87171; }
    .comparison-box.good .comparison-header { color: #34D399; }
    .comparison-list { list-style: none; padding: 0; margin: 0; font-size: 0.8rem; color: #CBD5E1; }
    .comparison-list li { display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.5rem; }
    .comparison-list li::before { content: '‚Ä¢'; color: inherit; }

    .pipeline-visual { background: #0F172A; border-radius: 0.75rem; padding: 1.5rem; margin: 1rem 0; }
    .pipeline-row { display: flex; align-items: center; margin-bottom: 1rem; }
    .pipeline-row:last-child { margin-bottom: 0; }
    .pipeline-stage { flex: 1; padding: 0.75rem; background: #1E293B; border-radius: 0.5rem; text-align: center; position: relative; }
    .pipeline-stage.highlight { background: linear-gradient(135deg, #0b5fff 0%, #0047cc 100%); }
    .pipeline-stage h5 { font-size: 0.75rem; font-weight: 600; color: white; margin: 0 0 0.25rem 0; }
    .pipeline-stage p { font-size: 0.7rem; color: #94A3B8; margin: 0; }
    .pipeline-stage.highlight p { color: rgba(255,255,255,0.8); }
    .pipeline-connector { width: 30px; display: flex; justify-content: center; color: #0b5fff; font-size: 1.25rem; }

    .evidence-card { background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 0.75rem; }
    .evidence-meta { font-size: 0.75rem; color: #64748B; margin-bottom: 0.5rem; }
    .evidence-quote { font-size: 0.875rem; color: #E2E8F0; white-space: pre-wrap; line-height: 1.5; }

    .modal-section-header {
      display: flex; align-items: center; gap: 0.5rem;
      font-size: 1rem; font-weight: 600; color: #0b5fff;
      margin: 1.5rem 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid #334155;
    }
    .modal-section-header:first-child { margin-top: 0; }
    .modal-section-header svg { width: 1.25rem; height: 1.25rem; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1E293B; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body>
<div id="docuwaivz-app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">Adopt<span class="logo-accent">(k)</span></div>
      <div class="form-hint" style="margin-top: 0.5rem;">Adoption Agreement Parser</div>
    </div>
    <div class="sidebar-content">
      <div class="mb-6">
        <button id="how-to-use-btn" class="info-btn mb-3">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
          <div class="info-btn-content"><div class="info-btn-title">How to Use</div><div class="info-btn-subtitle">Step-by-step guide</div></div>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:1rem;height:1rem;opacity:0.7;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
        <button id="whats-new-btn" class="info-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          <div class="info-btn-content"><div class="info-btn-title">What's New</div><div class="info-btn-subtitle">Certification system</div></div>
          <span class="info-btn-badge">NEW</span>
        </button>
      </div>
      <div class="mb-6 pt-4 border-t">
        <div class="section-title">1. LLM Model</div>
        <label class="form-label" for="llm-model">Model (server-side)</label>
        <select id="llm-model" class="form-select">
          <option value="gpt-5.2" selected>GPT-5.2 (default)</option>
          <option value="gemini-3-pro-preview">Gemini 3 Pro (Preview)</option>
          <option value="claude-sonnet-4-5">Claude Sonnet 4.5</option>
        </select>
        <div class="form-hint">Select the model to use, or keep the default</div>
      </div>
      <div class="mb-6 pt-4 border-t">
        <div class="section-title">2. Select Adoption Agreement</div>
        <label id="upload-label" class="upload-area">
          <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <span id="upload-text" class="form-hint">Click to select PDF</span>
          <input id="file-upload" type="file" accept=".pdf" />
        </label>
      </div>
      <div class="mb-6 pt-4 border-t">
        <div class="section-title">3. Status &amp; Processing</div>
        <div class="status-section">
          <div class="status-row"><span class="loader-dark" id="py-loader"></span><span id="status-text">Initializing System...</span></div>
          <div id="file-info" class="form-hint mt-3 hidden"></div>
        </div>
        <div id="error-box" class="error-box hidden"></div>
        <button id="retry-init-btn" class="btn btn-primary w-full mt-3 hidden">Retry Initialization</button>
      </div>
      <div class="mb-6 pt-4 border-t">
        <div class="section-title">4. Accuracy Settings</div>
        <div class="toggle-row"><div><div class="toggle-label">Strict Mode</div><div class="toggle-hint">Only show certified values</div></div><div id="strict-mode-toggle" class="toggle-switch active"></div></div>
        <div class="toggle-row"><div><div class="toggle-label">Show Reasons</div><div class="toggle-hint">Explain why fields are blank</div></div><div id="show-reasons-toggle" class="toggle-switch active"></div></div>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="form-hint"><strong style="color:white;">Trust Contract:</strong> If a value appears, it's certified correct. Empty fields mean we couldn't verify with certainty.</div>
    </div>
  </aside>
  <main class="main-content">
    <div class="results-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div><div class="results-title">Plan Extraction Results</div><div class="results-subtitle">Review the extracted data below. Certified values are verified from the source document.</div></div>
        <div style="text-align:right;"><div class="form-hint" style="color:rgba(255,255,255,0.7);">Trust Level</div><div style="font-size:1.125rem;font-weight:700;color:white;">100% or Silent</div></div>
      </div>
      <div id="coverage-bar" class="coverage-bar hidden"></div>
    </div>
    <div class="results-container">
      <div id="results-table" style="overflow-x:auto;"><p style="color:#94A3B8;text-align:center;padding:5rem 0;">Waiting for PDF upload and analysis...</p></div>
      <div id="results-loading-overlay" class="results-overlay hidden">
        <div class="clock-spinner"><div class="clock-hand-hour"></div><div class="clock-hand-minute"></div></div>
        <div class="overlay-text" id="results-overlay-text">Analyzing adoption agreement...</div>
        <div class="overlay-subtext">‚è™ Saving you hours of manual data entry</div>
      </div>
    </div>
    <div class="export-panel">
      <div class="export-header"><span class="export-title">Export Options</span><span id="export-mode-label" class="export-hint">Certified values only</span></div>
      <div class="export-buttons">
        <button id="export-copy-btn" class="btn btn-outline">üìã Copy</button>
        <button id="export-html-btn" class="btn btn-outline">üåê HTML Table</button>
        <button id="export-pdf-btn" class="btn btn-outline">üìÑ PDF Report</button>
        <button id="export-csv-btn" class="btn btn-outline">üìä CSV file</button>
        <button id="export-nextstep-btn" class="btn btn-primary">üöÄ Generate Pre-Filled DPF</button>
      </div>
    </div>
  </main>
</div>

<!-- HOW TO USE MODAL -->
<div id="how-to-use-modal" class="modal-backdrop hidden">
  <div class="modal-container large">
    <div class="modal-header">
      <h3><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:1.5rem;height:1.5rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg> How to Use Adopt(k)</h3>
      <button class="modal-close" data-close="how-to-use-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="quick-start"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Quick Start</button>
          <button class="tab-btn" data-tab="understanding"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Understanding Results</button>
          <button class="tab-btn" data-tab="exports"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>Exports & DPF</button>
          <button class="tab-btn" data-tab="tips"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Pro Tips</button>
        </div>
        <div class="tabs-content">
          <div class="tab-panel active" data-panel="quick-start">
            <div class="highlight-box success"><div class="highlight-box-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Save 30-45 Minutes Per Document</div><p style="color:#CBD5E1;margin:0;">Adopt(k) extracts plan design data from adoption agreements in under 60 seconds with certified accuracy.</p></div>
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>4 Simple Steps</div>
            <div class="step-card"><div class="step-number">1</div><div class="step-content"><h4>Select Your Model</h4><p>Choose the AI model for extraction. GPT-5.2 is recommended for best accuracy.</p></div></div>
            <div class="step-card"><div class="step-number">2</div><div class="step-content"><h4>Upload Your PDF</h4><p>Click the upload area and select your 401(k) adoption agreement. Make sure it's a text-searchable PDF.</p></div></div>
            <div class="step-card"><div class="step-number">3</div><div class="step-content"><h4>Wait for Analysis</h4><p>Watch the clock spin backwards as Adopt(k) saves you hours of manual work. Processing takes 30-60 seconds.</p></div></div>
            <div class="step-card"><div class="step-number">4</div><div class="step-content"><h4>Review & Export</h4><p>Check the certified values, then export to CSV, PDF, or generate a pre-filled DPF document.</p></div></div>
            <div class="flow-diagram"><div class="flow-step"><div class="flow-icon">üìÑ</div><div class="flow-label">Upload PDF</div></div><div class="flow-arrow">‚Üí</div><div class="flow-step"><div class="flow-icon">üîç</div><div class="flow-label">Extract Text</div></div><div class="flow-arrow">‚Üí</div><div class="flow-step"><div class="flow-icon">ü§ñ</div><div class="flow-label">AI Analysis</div></div><div class="flow-arrow">‚Üí</div><div class="flow-step"><div class="flow-icon">‚úÖ</div><div class="flow-label">Certified Data</div></div><div class="flow-arrow">‚Üí</div><div class="flow-step"><div class="flow-icon">üìä</div><div class="flow-label">Export</div></div></div>
          </div>
          <div class="tab-panel" data-panel="understanding">
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>The Trust Contract</div>
            <div class="highlight-box"><div class="highlight-box-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>100% Correct or Silent</div><p style="color:#CBD5E1;margin:0;">If Adopt(k) returns a value, you can trust it completely‚Äîno double-checking required. Empty fields mean we couldn't verify with certainty, which is intentional.</p></div>
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>Status Badges Explained</div>
            <div class="status-grid">
              <div class="status-explain-card"><span class="status-badge certified">CERTIFIED</span><div class="status-text">Value verified directly from document text. Safe to use without review.</div></div>
              <div class="status-explain-card"><span class="status-badge ambiguous">AMBIGUOUS</span><div class="status-text">Document uses unclear language like "may provide" or "at discretion".</div></div>
              <div class="status-explain-card"><span class="status-badge conflict">CONFLICT</span><div class="status-text">Multiple conflicting provisions found. Requires manual review.</div></div>
              <div class="status-explain-card"><span class="status-badge silent">SILENT</span><div class="status-text">Document doesn't address this provision at all.</div></div>
            </div>
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>Source Evidence</div>
            <p style="color:#CBD5E1;">Click the <button class="source-btn" style="cursor:default;">Source</button> button on any certified field to see exactly where in the document we found that value‚Äîincluding page number and verbatim quote.</p>
          </div>
          <div class="tab-panel" data-panel="exports">
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>Export Options</div>
            <div class="feature-grid">
              <div class="feature-box"><div class="feature-icon">üìã</div><h4>Copy</h4><p>Copy HTML table to clipboard for pasting into emails or documents</p></div>
              <div class="feature-box"><div class="feature-icon">üåê</div><h4>HTML Table</h4><p>Download formatted HTML file for web viewing or archiving</p></div>
              <div class="feature-box"><div class="feature-icon">üìÑ</div><h4>PDF Report</h4><p>Generate a professional PDF report with branding</p></div>
              <div class="feature-box"><div class="feature-icon">üìä</div><h4>CSV File</h4><p>Export data for Excel, Google Sheets, or other tools</p></div>
            </div>
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Pre-Filled DPF Generation</div>
            <div class="highlight-box success"><div class="highlight-box-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Automated Document Preparation</div><p style="color:#CBD5E1;margin:0;">Click "Generate Pre-Filled DPF" to create a Document Preparation Form with all certified values automatically populated. Only verified data is included‚Äîuncertain fields are left blank for manual entry.</p></div>
          </div>
          <div class="tab-panel" data-panel="tips">
            <div class="modal-section-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Tips for Best Results</div>
            <div class="step-card"><div class="step-number">üí°</div><div class="step-content"><h4>Use Text-Searchable PDFs</h4><p>Scanned documents without OCR will fail. If you see "image-based PDF" error, run OCR first using Adobe Acrobat or similar tool.</p></div></div>
            <div class="step-card"><div class="step-number">üéØ</div><div class="step-content"><h4>Principal Documents Work Best</h4><p>Adopt(k) is optimized for Principal 401(k) Nonstandardized Adoption Agreements. Support for other vendors is coming soon.</p></div></div>
            <div class="step-card"><div class="step-number">‚ö°</div><div class="step-content"><h4>Keep Strict Mode On</h4><p>Strict Mode ensures you only see verified data. Turning it off shows all extracted values, but some may need manual verification.</p></div></div>
            <div class="step-card"><div class="step-number">üîç</div><div class="step-content"><h4>Check Source Evidence</h4><p>Click the "Source" button to see exactly where each value came from in the document. Great for audits and compliance.</p></div></div>
            <div class="highlight-box"><div class="highlight-box-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>Need Help?</div><p style="color:#CBD5E1;margin:0;">Contact the Waivz team at <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="daa9afaaaab5a8ae9aadbbb3aca0f4bbb3">[email&#160;protected]</a> for custom integrations, additional document types, or any questions.</p></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" data-close="how-to-use-modal">Got It!</button></div>
  </div>
</div>
<h3>üöÄ Generate Pre-Filled DPF</h3><button class="modal-close" data-close="next-step-modal">&times;</button></div>
    <div class="modal-body" style="padding:1.5rem;">
      <p>Generate a Document Preparation Form (DPF) pre-filled with the certified extracted values. Only verified data will be included‚Äîuncertain fields are left blank for manual review.</p>
      <div class="highlight-box success"><div class="highlight-box-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:1.25rem;height:1.25rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>Quality Guarantee</div><p style="color:#CBD5E1;margin:0;">Every value in the generated DPF has been certified from the source document. No guessing, no assumptions.</p></div>
      <div class="feature-grid" style="margin-top:1rem;">
        <div class="feature-box"><div class="feature-icon">üè¢</div><h4>Company Info</h4><p>Name, address, EIN, entity type</p></div>
        <div class="feature-box"><div class="feature-icon">üìã</div><h4>Plan Details</h4><p>Name, dates, plan number</p></div>
        <div class="feature-box"><div class="feature-icon">üë•</div><h4>Eligibility</h4><p>Service, age, entry dates</p></div>
        <div class="feature-box"><div class="feature-icon">üí∞</div><h4>Contributions</h4><p>Match, safe harbor, vesting</p></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-close="next-step-modal">Cancel</button><button id="generate-dpf-btn" class="btn btn-primary">Generate DPF</button></div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
(function() {
  'use strict';
  const EXTRACTOR_API_BASE = "https://docuwaivz-plan-extractor-931273582090.us-central1.run.app";
  let STRICT_MODE = true, SHOW_BLANK_REASONS = true;
  let pyodideInstance = null, pdfjsLibInstance = null, initializationInProgress = false;
  let lastExtractionRows = null, lastHtmlTableString = "";

  const displayOrderMD = `## Company Information
Company Name
Company Street
Company Street2
City, State, ZIP
Company Telephone
EIN
Form of Business
Entity Type
## Corporate Details
Employer's Tax Year End
Plan Year End
Related Employers
Related Employers Detail
Multiple Employer Plan
Affiliated_Employers
## Plan Information
Plan Name
Original Effective Date
Restatement Effective Date
Plan Number
Type of Plan
Plan Year
## Eligibility
Eligible Employees
Are Union Employees Excluded?
Are Non-resident aliens Employees Excluded?
Are Part time Employees Excluded?
Are Employees as the result of a transaction described in Code section 410(b)(6)(C) Excluded?
List of Excluded Employee Groups
Is There More Than One Service Requirement?
Service Requirement
Hour Requirement
Minimum Age Requirement
Entry Date
Elapsed Time or Hours of Service
Effective Date of Age/Service Requirement (Amnesty Date)
Counting Predecessor Service
## Compensation
Definition of Compensation
Total Compensation
Plan Compensation Exclusions
Period for Determining Compensation
Using Entry Date Compensation
## Contributions
Employer Non-Elective/Profit Sharing Contribution
Employer Non-Elective/Profit Sharing Contribution Formula
Employer Non-Elective/Profit Sharing Contribution Formula Type
Employer Non-Elective/Profit Sharing Contribution Allocation Conditions
Exceptions to Employer Non-Elective/Profit Sharing Contribution Allocation Conditions
Salary Deferrals
Roth Deferrals
ADP/ACP Testing Method
In-Plan Roth Transfers/Conversions Permitted
Automatic Deferral Election
Automatic Deferral Election Start Date
Automatic Deferral Election Initial Percentage
Automatic Deferral Election Increase
Automatic Deferral Election Maximum Percentage
Automatic Deferral Election Applicable To
Matching Contributions
Matching Contribution Formula
Limit on Matching Contribution
Period for Determining Matching Contributions
Matching Contribution Allocation Conditions
Exceptions to Matching Contribution Allocation Conditions
## Safe Harbor
Safe Harbor 401(k) Plan
Is This a QACA Plan?
Safe Harbor Type
Safe Harbor Formula
Period for Determining Safe Harbor Contribution
Eligibility for Safe Harbor Contribution
Safe Harbor Delayed Effective Date
## Vesting
Normal Retirement Age
Early Retirement Age
Retirement Age Years of Participation Required
Retirement Age Years of Employment Required
Vesting Schedule
Vesting Exclusions
Vesting for QACA
Immediate Vesting Upon Death, Disability, ERA
## Distributions
In-Service Distributions at Age 59.5
Sources Available for In-Service Distributions at Age 59.5
Hardship Distributions
Sources Available for Hardship Distributions
Loans Allowed
Number of Loans Allowed at a Time
Loan Rate of Interest
## Administration
Top Paid Group Applicable
Owner/Trustee Name
Trustee Title
Will a Recipient be entitled to request a Direct In-Plan Roth Rollover
`;

  const pythonCleaningScript = `
import re
def clean_extracted_text(text, collapse_internal_spaces=True, preserve_indent=False):
    if not text: return text
    replacements = [('\\u00a0', ' '),('\\u2019', "'"),('\\u2018', "'"),('\\u201c', '"'),('\\u201d', '"'),('\\u2013', '-'),('\\u2014', '-')]
    for old, new in replacements: text = text.replace(old, new)
    lines = text.split('\\n')
    cleaned_lines = []
    for line in lines:
        s = line.strip()
        if collapse_internal_spaces and s: s = ' '.join(s.split())
        cleaned_lines.append(s)
    text = '\\n'.join(cleaned_lines)
    while '\\n\\n\\n' in text: text = text.replace('\\n\\n\\n', '\\n\\n')
    return text
`;

  function qs(sel) { return document.querySelector('#docuwaivz-app ' + sel) || document.querySelector(sel); }
  function escapeHtml(u) { if(u==null)return'';if(typeof u!=='string')return String(u);return u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
  function showOverlay(m) { const o=qs('#results-loading-overlay'),t=qs('#results-overlay-text');if(o)o.classList.remove('hidden');if(t&&m)t.textContent=m; }
  function hideOverlay() { const o=qs('#results-loading-overlay');if(o)o.classList.add('hidden'); }
  function updateStatus(t,e=false,h=false) { const s=qs('#status-text'),l=qs('#py-loader');if(!s)return;s.textContent=t;s.style.color=e?'#FCA5A5':(h?'#6EE7B7':'white');if(l){if(h||e)l.classList.add('hidden');else l.classList.remove('hidden');} }
  function showError(m,d=null) { const e=qs('#error-box'),r=qs('#retry-init-btn');if(!e)return;let c=`<strong>Error:</strong> ${escapeHtml(m)}`;if(d)c+=`<br><br><pre style="margin-top:0.5rem;font-size:0.7rem;overflow-x:auto;">${escapeHtml(d)}</pre>`;e.innerHTML=c;e.classList.remove('hidden');if(r&&initializationInProgress)r.classList.remove('hidden'); }
  function enableUpload() { const u=qs('#upload-label');if(u)u.classList.add('enabled'); }

  function setupToggles() {
    const st=qs('#strict-mode-toggle'),rt=qs('#show-reasons-toggle'),el=qs('#export-mode-label');
    if(st)st.addEventListener('click',function(){STRICT_MODE=!STRICT_MODE;this.classList.toggle('active',STRICT_MODE);if(el)el.textContent=STRICT_MODE?'Certified values only':'All extracted values';if(lastExtractionRows)renderData(lastExtractionRows);});
    if(rt)rt.addEventListener('click',function(){SHOW_BLANK_REASONS=!SHOW_BLANK_REASONS;this.classList.toggle('active',SHOW_BLANK_REASONS);if(lastExtractionRows)renderData(lastExtractionRows);});
  }

  function setupTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn=>{btn.addEventListener('click',function(){const t=this.dataset.tab,c=this.closest('.tabs-container');c.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));c.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));this.classList.add('active');c.querySelector(`[data-panel="${t}"]`).classList.add('active');});});
  }

  function parseDisplayOrder(md) { const ls=md.split('\n'),of=[];let cg=null;ls.forEach(l=>{l=l.trim();if(!l)return;if(l.startsWith('##'))cg=l.replace(/^#+\s*/,'').trim();else if(cg)of.push({group:cg,fieldName:l});});return of; }
  function buildRowLookup(rs) { const lk={};rs.forEach(r=>{if(!r||typeof r.label!=='string')return;lk[r.label]=r;});return lk; }
  function getStatusClass(s) { const st=(s||'').toUpperCase();if(st==='CERTIFIED'||st==='OK')return'certified';if(st==='AMBIGUOUS')return'ambiguous';if(st==='CONFLICT')return'conflict';if(st==='SILENT'||st==='NOT_FOUND')return'silent';return'uncertain'; }
  function isCertified(s) { const st=(s||'').toUpperCase();return st==='CERTIFIED'||st==='OK'||st===''; }

  function computeCoverage(rs,do_) { const rl=buildRowLookup(rs);let c=0,r=0,s=0;do_.forEach(i=>{const ro=rl[i.fieldName],st=(ro?.status||'').toUpperCase(),v=ro?.value||'';if(st==='CERTIFIED'||st==='OK'||(v&&!st))c++;else if(st==='SILENT'||st==='NOT_FOUND'||!v)s++;else r++;});return{certified:c,review:r,silent:s,total:do_.length}; }
  function renderCoverage(rs) { const cb=qs('#coverage-bar');if(!cb)return;const do_=parseDisplayOrder(displayOrderMD),c=computeCoverage(rs,do_);cb.innerHTML=`<div class="coverage-pill certified">‚úì Certified: ${c.certified}</div><div class="coverage-pill review">‚ö† Needs Review: ${c.review}</div><div class="coverage-pill silent">‚Äî Silent: ${c.silent}</div>`;cb.classList.remove('hidden'); }

  function buildHtmlTable(rs) {
    const do_=parseDisplayOrder(displayOrderMD),rl=buildRowLookup(rs);let h='<table class="results-table">';let cg=null;
    h+=`<thead><tr><th class="field-col">Field Name</th><th class="value-col">Value</th></tr></thead>`;
    do_.forEach(it=>{
      const ro=rl[it.fieldName],rv=ro?.value??'',st=ro?.status||'',re=ro?.reason||'',ev=Array.isArray(ro?.evidence)?ro.evidence:[];
      const v=(typeof rv==='string')?rv.trim():rv,ce=isCertified(st),sc=getStatusClass(st),sv=STRICT_MODE?(ce&&v):!!v,ve=sv&&v!==null&&v!==undefined&&v!=='';
      if(it.group!==cg){if(cg!==null)h+='</tbody>';cg=it.group;h+=`<tbody><tr class="section-header-row"><td colspan="2">${escapeHtml(cg)}</td></tr>`;}
      let sb='';if(!ce&&SHOW_BLANK_REASONS&&st){sb=`<span class="status-badge ${sc}">${escapeHtml(st)}</span>`;if(re)sb+=`<span style="margin-left:0.5rem;font-size:0.75rem;color:#94A3B8;">${escapeHtml(re)}</span>`;}
      let so='';if(ce&&ev.length>0&&ve)so=`<button class="source-btn" onclick='showEvidence(${JSON.stringify(JSON.stringify({field:it.fieldName,evidence:ev}))})'>Source</button>`;
      h+=`<tr class="data-row"><td class="field-cell">${escapeHtml(it.fieldName)}</td><td class="value-cell ${ve?'':'empty-value'}"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.75rem;"><div style="flex:1;min-width:0;">${ve?escapeHtml(v):''}${!ve&&sb?`<div style="margin-top:0.25rem;">${sb}</div>`:''}</div>${so?`<div style="flex-shrink:0;">${so}</div>`:''}</div></td></tr>`;
    });
    if(cg!==null)h+='</tbody>';h+='</table>';return h;
  }
  function renderData(rs) { const rt=qs('#results-table');if(!rt)return;const ht=buildHtmlTable(rs);lastHtmlTableString=ht;lastExtractionRows=rs;rt.innerHTML=ht;renderCoverage(rs); }

  window.showEvidence=function(ds){try{const d=JSON.parse(ds),m=document.getElementById('evidence-modal'),b=document.getElementById('evidence-body');if(!m||!b)return;const f=d.field||'Field',e=Array.isArray(d.evidence)?d.evidence:[];b.innerHTML=`<div style="margin-bottom:1rem;"><div style="font-size:1.125rem;font-weight:600;color:white;">${escapeHtml(f)}</div><div style="font-size:0.875rem;color:#94A3B8;">Certified source excerpts from the document</div></div>${e.map(ev=>`<div class="evidence-card"><div class="evidence-meta">${ev.page?`Page ${escapeHtml(String(ev.page))}`:''}${ev.section?` ‚Ä¢ Section ${escapeHtml(String(ev.section))}`:''}</div><div class="evidence-quote">"${escapeHtml(ev.quote||'')}"</div></div>`).join('')}${e.length===0?'<p style="color:#94A3B8;">No source evidence available.</p>':''}`;m.classList.remove('hidden');}catch(e){console.error('Failed to parse evidence:',e);}};

  async function callExtractorBackend(ct) {
    const ms=qs('#llm-model'),m=ms?ms.value:null;
    const p={document_text:ct,vendor_hint:"Principal 401(k) Nonstandardized Adoption Agreement",model:m,display_order_md:displayOrderMD,strict_mode:true,return_evidence:true};
    const r=await fetch(`${EXTRACTOR_API_BASE}/extract-plan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
    if(!r.ok){const t=await r.text();throw new Error(`Extractor HTTP ${r.status}: ${t.slice(0,200)}...`);}
    const d=await r.json();if(!d.rows||!Array.isArray(d.rows))throw new Error("Extractor response missing rows[].");
    console.log("Model used by backend:",d.model_used);return d.rows;
  }

  function ensureExtractionAvailable(){if(!lastExtractionRows||!Array.isArray(lastExtractionRows)||lastExtractionRows.length===0){alert("No extraction available. Run an extraction first.");return false;}return true;}
  function downloadFile(f,m,c){const b=new Blob([c],{type:m}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}
  async function handleExportCopy(){if(!ensureExtractionAvailable())return;try{await navigator.clipboard.writeText(lastHtmlTableString||buildHtmlTable(lastExtractionRows));alert("HTML table copied to clipboard.");}catch(e){alert("Copy failed.");}}
  function handleExportHtml(){if(!ensureExtractionAvailable())return;downloadFile("plan_extraction.html","text/html;charset=utf-8",`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Plan Extraction</title></head><body>${lastHtmlTableString||buildHtmlTable(lastExtractionRows)}</body></html>`);}
  function handleExportCsv(){if(!ensureExtractionAvailable())return;const do_=parseDisplayOrder(displayOrderMD),rl=buildRowLookup(lastExtractionRows);let c='Field Name,Value,Status\n';do_.forEach(i=>{const ro=rl[i.fieldName],ce=isCertified(ro?.status);let v=ro?.value??'';if(STRICT_MODE&&!ce)v='';c+=`"${i.fieldName.replace(/"/g,'""')}","${String(v).replace(/"/g,'""')}","${ce?'CERTIFIED':(ro?.status||'UNCERTAIN')}"\n`;});downloadFile("plan_extraction.csv","text/csv;charset=utf-8",c);}
  function handleExportPdf(){if(!ensureExtractionAvailable())return;const do_=parseDisplayOrder(displayOrderMD),rl=buildRowLookup(lastExtractionRows);let h=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Plan Extraction Report</title><style>body{font-family:sans-serif;font-size:11px;color:#1e293b;}.header{background:linear-gradient(135deg,#0b5fff,#0047cc);color:white;padding:20px;text-align:center;margin-bottom:20px;}.header h1{margin:0;font-size:24px;}table{width:100%;border-collapse:collapse;}th{background:#0b5fff;color:white;padding:10px;text-align:left;}td{padding:8px;border:1px solid #cbd5e1;}.section{background:#f1f5f9;color:#0b5fff;font-weight:bold;text-transform:uppercase;border-left:4px solid #0b5fff;}.field{background:#f8fafc;width:35%;}.footer{margin-top:20px;text-align:center;font-size:10px;color:#64748b;}</style></head><body><div class="header"><h1>Plan Extraction Report</h1><p>Generated by Adopt(k) - Waivz.ai</p></div><table><thead><tr><th>Field Name</th><th>Value</th></tr></thead><tbody>`;let cg=null;do_.forEach(i=>{const ro=rl[i.fieldName],ce=isCertified(ro?.status);let v=ro?.value??'';if(STRICT_MODE&&!ce)v='';if(i.group!==cg){cg=i.group;h+=`<tr><td colspan="2" class="section">${escapeHtml(cg)}</td></tr>`;}h+=`<tr><td class="field">${escapeHtml(i.fieldName)}</td><td>${escapeHtml(v)}</td></tr>`;});h+=`</tbody></table><div class="footer">Generated ${new Date().toLocaleString()} | Adopt(k) by Waivz.ai</div></body></html>`;const pw=window.open('','_blank');pw.document.write(h);pw.document.close();setTimeout(()=>pw.print(),250);}
  async function generateDPF(){if(!ensureExtractionAvailable())return;const cr=lastExtractionRows.find(r=>r.label==="Company Name"),cn=cr?cr.value:"Plan",btn=document.getElementById('generate-dpf-btn');if(btn){btn.textContent="‚è≥ Generating...";btn.disabled=true;}try{const crs=lastExtractionRows.filter(r=>isCertified(r.status)),res=await fetch(`${EXTRACTOR_API_BASE}/fill-dpf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:crs,company_name:cn})});if(!res.ok)throw new Error(await res.text()||`Server error: ${res.status}`);const bl=await res.blob(),fn=`DPF_${cn.replace(/[^a-zA-Z0-9]/g,'_').substring(0,30)}_${new Date().toISOString().split('T')[0]}.docx`,url=URL.createObjectURL(bl),a=document.createElement('a');a.href=url;a.download=fn;a.click();URL.revokeObjectURL(url);closeModal('next-step-modal');alert(`‚úÖ DPF generated successfully!\n\nFile: ${fn}`);}catch(e){alert(`‚ùå Failed to generate DPF\n\n${e.message}`);}finally{if(btn){btn.textContent="Generate DPF";btn.disabled=false;}}}

  function openModal(id){const m=document.getElementById(id);if(m)m.classList.remove('hidden');}
  function closeModal(id){const m=document.getElementById(id);if(m)m.classList.add('hidden');}
  function setupModals(){document.querySelectorAll('[data-close]').forEach(b=>{b.addEventListener('click',()=>closeModal(b.dataset.close));});document.querySelectorAll('.modal-backdrop').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.add('hidden');});});qs('#how-to-use-btn')?.addEventListener('click',()=>openModal('how-to-use-modal'));qs('#whats-new-btn')?.addEventListener('click',()=>openModal('whats-new-modal'));qs('#export-nextstep-btn')?.addEventListener('click',()=>openModal('next-step-modal'));document.getElementById('generate-dpf-btn')?.addEventListener('click',generateDPF);}

  function loadScript(s){return new Promise((r,j)=>{const sc=document.createElement('script');sc.src=s;sc.onload=r;sc.onerror=()=>j(new Error(`Failed to load: ${s}`));document.head.appendChild(sc);});}
  async function loadPdfJs(){if(window.pdfjsLib)return;await loadScript("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js");if(!window.pdfjsLib)throw new Error("PDF.js failed to initialize");}
  async function loadPyodide(){if(window.loadPyodide)return;await loadScript("https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js");if(!window.loadPyodide)throw new Error("Pyodide failed to initialize");}

  async function initEngine(){if(initializationInProgress)return;initializationInProgress=true;const eb=qs('#error-box'),rb=qs('#retry-init-btn');if(eb)eb.classList.add('hidden');if(rb)rb.classList.add('hidden');try{updateStatus("Step 1/3: Loading PDF Reader...");await loadPdfJs();pdfjsLibInstance=window.pdfjsLib;updateStatus("Step 2/3: Loading Python Runtime...");await loadPyodide();pyodideInstance=await window.loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"});updateStatus("Step 3/3: Initializing Scripts...");await pyodideInstance.runPythonAsync(pythonCleaningScript);updateStatus("Engine Ready",false,true);enableUpload();initializationInProgress=false;}catch(e){console.error("Initialization failed:",e);updateStatus("Initialization Failed",true,true);showError(e.message);initializationInProgress=false;}}

  function setupFileUpload(){const fi=qs('#file-upload');if(!fi)return;fi.addEventListener('change',async e=>{const f=e.target.files[0];if(!f||f.type!=='application/pdf'){alert("Please upload a valid PDF file.");return;}if(!pyodideInstance||!pdfjsLibInstance){showError("Engine is not ready. Please wait or retry initialization.");return;}qs('#error-box')?.classList.add('hidden');const finfo=qs('#file-info');if(finfo){finfo.textContent=`File: ${f.name} | Size: ${(f.size/1024).toFixed(1)} KB`;finfo.classList.remove('hidden');}updateStatus("Reading PDF...");showOverlay("Processing selected PDF...");try{const ab=await f.arrayBuffer(),ta=new Uint8Array(ab);updateStatus("Extracting text...");showOverlay("Extracting text from PDF...");const pdf=await pdfjsLibInstance.getDocument({data:ta}).promise;let ft="";for(let i=1;i<=pdf.numPages;i++){if(i%10===0)updateStatus(`Extracting page ${i}/${pdf.numPages}...`);const pg=await pdf.getPage(i),tc=await pg.getTextContent();ft+=tc.items.map(it=>it.str).join(' ')+"\n";}if(ft.trim().length<100)throw new Error("This PDF appears to be scanned or image-based. Please use OCR first.");updateStatus("Cleaning text...");showOverlay("Normalizing extracted text...");const cf=pyodideInstance.globals.get('clean_extracted_text'),ct=cf(ft,true,false);updateStatus("Analyzing...");showOverlay("Analyzing adoption agreement...");const rs=await callExtractorBackend(ct);renderData(rs);hideOverlay();updateStatus("Analysis Complete",false,true);}catch(er){console.error(er);updateStatus("Processing Error",true,true);showError(er.message);hideOverlay();}});}

  function setupExportButtons(){qs('#export-copy-btn')?.addEventListener('click',handleExportCopy);qs('#export-html-btn')?.addEventListener('click',handleExportHtml);qs('#export-pdf-btn')?.addEventListener('click',handleExportPdf);qs('#export-csv-btn')?.addEventListener('click',handleExportCsv);qs('#retry-init-btn')?.addEventListener('click',initEngine);}

  function init(){hideOverlay();setupToggles();setupTabs();setupModals();setupFileUpload();setupExportButtons();initEngine();}
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
})();
</script>
</body>
</html>